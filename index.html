<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Shopping List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        .container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #2e2e50;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2e2e50;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            text-align: center;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-purple-400">Collaborative Shopping List</h1>
        <div class="bg-indigo-900 bg-opacity-40 p-4 rounded-lg mb-4 text-center">
            <h2 class="text-lg font-semibold">User ID:</h2>
            <p id="user-id" class="text-sm break-all font-mono text-purple-200 mt-2"></p>
        </div>
        <form id="add-item-form" class="flex flex-col sm:flex-row gap-4 mb-6">
            <input type="text" id="item-input" placeholder="Add a new item..." required
                   class="flex-grow p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all">
            <button type="submit"
                    class="p-3 bg-purple-600 rounded-lg font-semibold hover:bg-purple-700 transition-colors shadow-lg">
                Add Item
            </button>
        </form>
        <div id="shopping-list-container">
            <ul id="shopping-list" class="space-y-4"></ul>
        </div>
    </div>

    <!-- The Modal -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modal-message" class="text-white text-lg"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, getDocs, query, where, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // UI Elements
        const itemInput = document.getElementById('item-input');
        const addItemForm = document.getElementById('add-item-form');
        const shoppingList = document.getElementById('shopping-list');
        const userIdDisplay = document.getElementById('user-id');
        const modal = document.getElementById('myModal');
        const modalMessage = document.getElementById('modal-message');
        const closeModalButton = document.querySelector('.close-button');

        // Function to show custom modal message
        function showModal(message) {
            modalMessage.textContent = message;
            modal.style.display = 'flex';
        }

        // Close modal when the user clicks on <span> (x)
        closeModalButton.onclick = function() {
            modal.style.display = 'none';
        };

        // Close modal when the user clicks anywhere outside of the modal
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };

        // Function to handle authentication and database setup
        async function setupApp() {
            try {
                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                const user = auth.currentUser;
                const userId = user.uid;
                userIdDisplay.textContent = userId;

                // Create a reference to the shopping list collection in Firestore
                const listCollectionRef = collection(db, `artifacts/${appId}/public/data/shopping_list`);

                // Set up a real-time listener for the shopping list
                onSnapshot(listCollectionRef, (snapshot) => {
                    const items = [];
                    snapshot.forEach((doc) => {
                        const itemData = doc.data();
                        items.push({
                            id: doc.id,
                            name: itemData.name,
                            checked: itemData.checked,
                            userId: itemData.userId
                        });
                    });
                    renderShoppingList(items, userId);
                });

                // Handle adding a new item to the list
                addItemForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const itemName = itemInput.value.trim();
                    if (itemName) {
                        try {
                            // Add a new document to the collection
                            await addDoc(listCollectionRef, {
                                name: itemName,
                                checked: false,
                                userId: userId,
                                timestamp: Date.now()
                            });
                            itemInput.value = '';
                        } catch (error) {
                            console.error("Error adding document: ", error);
                            showModal("Error adding item: " + error.message);
                        }
                    } else {
                        showModal("Please enter an item name.");
                    }
                });

            } catch (error) {
                console.error("Firebase setup failed:", error);
                showModal("Failed to connect to the database: " + error.message);
            }
        }

        // Function to render the shopping list on the page
        function renderShoppingList(items, currentUserId) {
            shoppingList.innerHTML = ''; // Clear the list
            if (items.length === 0) {
                shoppingList.innerHTML = '<p class="text-center text-gray-400">The list is currently empty.</p>';
            } else {
                // Sort items by timestamp (not in Firestore query to avoid index issues)
                items.sort((a, b) => a.timestamp - b.timestamp);

                items.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = `flex items-center justify-between p-4 rounded-lg transition-all ${item.checked ? 'bg-gray-700 opacity-60 line-through' : 'bg-gray-800'}`;
                    listItem.innerHTML = `
                        <div class="flex items-center flex-grow">
                            <input type="checkbox" data-id="${item.id}" ${item.checked ? 'checked' : ''} 
                                   class="form-checkbox h-5 w-5 text-purple-600 rounded focus:ring-purple-500 mr-4 cursor-pointer bg-gray-600 border-gray-500">
                            <span class="flex-grow text-white">${item.name}</span>
                            <span class="text-xs text-gray-400 ml-2">(${item.userId.substring(0, 4)}...)</span>
                        </div>
                        <button data-id="${item.id}"
                                class="delete-button p-2 text-red-400 hover:text-red-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    shoppingList.appendChild(listItem);

                    // Add event listeners for the checkbox and delete button
                    listItem.querySelector('input[type="checkbox"]').addEventListener('change', async (e) => {
                        const docId = e.target.dataset.id;
                        const docRef = doc(db, `artifacts/${appId}/public/data/shopping_list`, docId);
                        try {
                            await updateDoc(docRef, { checked: e.target.checked });
                        } catch (error) {
                            console.error("Error updating document:", error);
                            showModal("Error updating item: " + error.message);
                        }
                    });

                    listItem.querySelector('.delete-button').addEventListener('click', async (e) => {
                        const docId = e.currentTarget.dataset.id;
                        const docRef = doc(db, `artifacts/${appId}/public/data/shopping_list`, docId);
                        try {
                            await deleteDoc(docRef);
                        } catch (error) {
                            console.error("Error deleting document:", error);
                            showModal("Error deleting item: " + error.message);
                        }
                    });
                });
            }
        }

        // Start the application
        setupApp();

    </script>
</body>
</html>
